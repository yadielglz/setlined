rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Users can upload their own profile pictures
    match /users/{userId}/profile.{extension} {
      allow read, write: if request.auth != null &&
        request.auth.uid == userId &&
        request.auth.token.email_verified == true;
    }

    // Users can upload customer-related documents
    match /customers/{customerId}/{allPaths=**} {
      allow read, write: if request.auth != null &&
        request.auth.token.email_verified == true &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.locationId ==
        get(/databases/$(database)/documents/customers/$(customerId)).data.locationId;
    }

    // Employees can upload their own documents
    match /employees/{employeeId}/{allPaths=**} {
      allow read, write: if request.auth != null &&
        request.auth.token.email_verified == true &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'manager' ||
         request.auth.uid == employeeId);
    }
  }
}